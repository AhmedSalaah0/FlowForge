@model IEnumerable<SectionWithTasksResponse>
@{
    ViewBag.Title = "Tasks";
    var projectId = ViewBag.ProjectId;
}

<div class="container mt-4">
    <div class="mb-4 border-bottom border-secondary pb-2">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h3 text-light d-flex align-items-center gap-2 m-0">
                <i class="fas fa-columns"></i> Tasks Board
            </h1>

            <div class="dropdown" data-bs-display="static">
                <button class="btn btn-outline-info btn-sm @(ViewBag.visibility == ProjectVisibility.Public ? "text-success" : "text-danger")" type="button"
                        data-bs-toggle="dropdown" aria-expanded="false">
                    @TempData["Visibility"]
                </button>

                <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end" aria-labelledby="taskMenuButton">
    @foreach (var visibility in Enum.GetValues(typeof(ProjectVisibility)).Cast<ProjectVisibility>())
    {
        <li>
            <form asp-controller="Projects" asp-action="ChangeVisibility" method="post">
                <input type="hidden" name="ProjectId" value="@ViewBag.projectId" />
                <input type="hidden" name="ProjectVisibility" value="@visibility" />
                <button type="submit" class="dropdown-item @(visibility == ProjectVisibility.Public ? "text-success" : "text-danger")">
                    @visibility.ToString()
                </button>
            </form>
        </li>
    }
</ul>
            </div>
        </div>

        <p class="text-light mb-0">Manage your project tasks by sections</p>
    </div>


    @if (!ViewData.ModelState.IsValid)
    {
        foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
        {
            <div class="alert alert-danger">@error.ErrorMessage</div>
        }
    }

    @if (ViewBag.Members != null)
    {
        <div class="dropdown mb-4">
            <button class="btn btn-outline-info dropdown-toggle d-flex align-items-center gap-2 fade-in" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-users"></i>
                Project Members
            </button>

            <ul class="dropdown-menu dropdown-menu-dark p-2 shadow" style="min-width: 250px;">
                @foreach (var member in ViewBag.Members)
                {
                    <li class="dropdown-item d-flex align-items-center justify-content-between gap-2 px-2 py-2 rounded-2">
                        <div class="d-flex align-items-center gap-2">
                            <div class="avatar bg-info text-white fw-semibold rounded-circle d-flex align-items-center justify-content-center"
                                 style="width: 28px; height: 28px; font-size: 0.8rem;">
                                @member.Member.PersonName?[0].ToString().ToUpper()
                            </div>
                            <div class="lh-sm">
                                <div class="fw-medium text-light" style="font-size: 0.85rem;">
                                    @member.Member.PersonName
                                </div>
                                <div class="text-info" style="font-size: 0.75rem;">
                                    @member.MemberRole
                                </div>
                            </div>
                        </div>

                        @if(member.MemberRole != ProjectRole.Creator)
                        {
                            <form asp-controller="ProjectMembers"
                                  asp-action="RemoveMember"
                                  asp-route-projectId="@projectId"
                                  asp-route-memberId="@member.Member.Id"
                                  method="post" class="d-inline m-0">
                                <button type="submit" class="btn btn-outline-danger btn-sm" title="Remove Member">
                                    <i class="fas fa-user-minus"></i>
                                </button>
                            </form>
                        }
                    </li>
                }
            </ul>
        </div>
    }

    <div class="flex-wrap-fix">
        @foreach (var s in Model)
        {
            <div class="card bg-dark text-white shadow-sm p-3 border border-secondary rounded-4 fade-in" style="min-width: 50vh; flex: 0 0 auto;">
                <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                    <h5 class="text-info m-0 editable-section" data-section-id="@s.SectionId" data-project-id="@s.ProjectId">
                        @s.SectionName
                    </h5>

                    <a asp-controller="Sections" asp-action="DeleteSection" asp-route-sectionId="@s.SectionId" asp-route-projectId="@s.ProjectId"
                       class="btn btn-sm btn-outline-danger" title="Delete Section">
                        <i class="fas fa-trash-alt"></i>
                    </a>
                </div>

                <div class="task-list" id="section-@s.SectionId" data-section-id="@s.SectionId" data-project-id="@s.ProjectId">

                    @foreach (var task in s.Tasks.OrderBy(o => o.Order).ThenBy(o => o.Status))
                    {
                        <div class="task-card mb-3 p-3 rounded-3 shadow-sm bg-dark text-light position-relative fade-in" data-task-id="@task.TaskId">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="form-check mt-1">
                                    <input class="form-check-input" type="checkbox"
                                           id="taskCheck_@task.TaskId"
                                           data-status="@task.Status.ToString()"
                                           data-project-id = "@task.ProjectId"
                                           data-task-id="@task.TaskId"
                                           @(task.Status == ProjectTaskStatus.Completed ? "checked" : "") />
                                </div>

                                <div class="ms-2 flex-grow-1">
                                    <div class="fw-semibold @(task.Status == ProjectTaskStatus.Completed ? "text-decoration-line-through text-secondary" : "")">
                                        @task.Title
                                    </div>

                                    @if (!string.IsNullOrWhiteSpace(task.Description))
                                    {
                                        <div class="small text-secondary">@task.Description</div>
                                    }

                                    @if (task.ScheduleDateTime.HasValue)
                                    {
                                        <div class="small text-warning mt-1">
                                            <i class="fas fa-clock me-1"></i>@task.ScheduleDateTime?.ToString("dd MMM yyyy hh:mm tt")
                                        </div>
                                    }
                                </div>

                            <div class="dropdown ms-2" data-bs-display="static">
                                <button class="btn btn-outline-info btn-sm" type="button" id="taskMenuButton-@task.TaskId"
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>

                                <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="taskMenuButton-@task.TaskId">
                                    <li>
                                        <a class="dropdown-item"
                                           asp-controller="Tasks" asp-action="EditTask"
                                           asp-route-projectId="@task.ProjectId" asp-route-taskId="@task.TaskId">
                                            <i class="fas fa-pen me-2"></i> Edit Task
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item text-danger"
                                           asp-controller="Tasks" asp-action="DeleteTask"
                                           asp-route-projectId="@task.ProjectId" asp-route-taskId="@task.TaskId">
                                            <i class="fas fa-trash-alt me-2"></i> Delete Task
                                        </a>
                                    </li>
                                </ul>
                            </div>

                            </div>

                            <div class="d-flex gap-2 mt-3">

                                    <div class="dropdown" data-bs-display="static">
                                    <button id="selectedStatus_@task.TaskId" class="btn btn-sm d-flex align-items-center gap-2 px-2 py-1 rounded-2 border border-secondary text-light"
                                            type="button"
                                            data-bs-display="static"
                                            data-bs-toggle="dropdown"
                                            aria-expanded="false"
                                            data-status="@task.Status.ToString()"
                                            style="font-size: 0.8rem;">
                                        <span class="status-dot"
                                              style="width: 10px; height: 10px; border-radius: 50%; display: inline-block;
                                              background-color:@(task.Status == ProjectTaskStatus.Pending ? "#ffc107" :
                                                                task.Status == ProjectTaskStatus.In_Progress ? "#0d6efd" :
                                                                task.Status == ProjectTaskStatus.Completed ? "#198754" : "#6c757d");">
                                        </span>
                                        <span class="fw-semibold">@task.Status.ToString().Replace("_", " ")</span>
                                        <i class="fas fa-chevron-down ms-1 small"></i>
                                    </button>

                                        <ul class="dropdown-menu dropdown-menu-dark shadow-sm">
                                        @foreach (var status in Enum.GetValues(typeof(ProjectTaskStatus)).Cast<ProjectTaskStatus>())
                                        {
                                            <li>
                                                <button type="button"
                                                        class="dropdown-item d-flex align-items-center gap-2 status-option @(status == task.Status ? "active" : "")"
                                                        data-task-id="@task.TaskId"
                                                        data-project-id ="@task.ProjectId"
                                                        data-status="@status">
                                                        <span class="status-dot" style="background-color:@(status == ProjectTaskStatus.Pending ? "#ffc107" :
                                                                            status == ProjectTaskStatus.In_Progress ? "#0d6efd" :
                                                                            status == ProjectTaskStatus.Completed ? "#198754" : "#6c757d");">
                                                    </span>
                                                    @status.ToString().Replace("_", " ")
                                                </button>
                                            </li>
                                        }
                                    </ul>
                                </div>

                                <div class="dropdown">
                                    <button id="Assignee_@task.TaskId" class="btn btn-sm d-flex align-items-center gap-2 px-2 py-1 rounded-2 border border-secondary text-light"
                                            type="button"
                                            data-bs-toggle="dropdown"
                                            aria-expanded="false"
                                            style="font-size: 0.8rem;">
                                        <span id="Assignee-span-@task.TaskId">@(task.Assignee?.Member.PersonName ?? "Unassigned")</span>
                                        <i class="fas fa-user ms-1 small" aria-hidden="true"></i>
                                    </button>

                                        <ul class="dropdown-menu dropdown-menu-dark shadow-sm">
                                        @foreach (var person in task.Project.ProjectMembers)
                                        {
                                            <li>
                                                <button type="button"
                                                        class="dropdown-item d-flex align-items-center gap-2 assignee-option @(task.Assignee?.MemberId == person.MemberId ? "active" : "")"
                                                        data-task-id="@task.TaskId"
                                                        data-project-id = "@task.ProjectId"
                                                        data-assignee-id="@person.MemberId"
                                                        data-old-assinee-id ="@task.AssigneeId"
                                                         id="assignee-name-@person.MemberId">
                                                    @person.Member.PersonName
                                                </button>
                                            </li>
                                        }
                                    </ul>
                                </div>
                            </div>
                        </div>
                }
                </div>

                <a asp-controller="Tasks" asp-action="Task"
                   asp-route-projectId="@projectId"
                   asp-route-sectionId="@s.SectionId"
                   class="btn btn-sm btn-outline-light w-100 mt-2">
                    <i class="fas fa-plus me-1"></i> Add Task
                </a>
            </div>
        }

        <div class="card bg-dark text-white border border-secondary p-3 rounded-4 d-flex align-items-center justify-content-start fade-in"
             style="min-width: 300px; flex: 0 0 auto;">
            <form asp-controller="Sections" asp-action="AddSection" method="post" class="w-100">
                @Html.AntiForgeryToken()
                <input type="hidden" name="ProjectId" value="@projectId" />
                <div class="mb-2">
                    <input name="SectionName" class="form-control bg-secondary text-white border-0" placeholder="New Section..." required />
                </div>
                <button type="submit" class="btn btn-outline-info w-100">
                    <i class="fas fa-plus me-1"></i> Add Section
                </button>
            </form>
        </div>
    </div>
</div>

<script src="~/scripts/tasks-board.js"></script>