@model IEnumerable<SectionWithTasksResponse>
@{
    ViewBag.Title = "Tasks";
    var projectId = ViewBag.ProjectId;
}

<div class="container mt-4">
    <div class="mb-4 border-bottom border-secondary pb-2">
        <h1 class="h3 text-light d-flex align-items-center gap-2">
            <i class="fas fa-columns"></i> Tasks Board
        </h1>
        <p class="text-light">Manage your project tasks by sections</p>
    </div>

    @if (!ViewData.ModelState.IsValid)
    {
        foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
        {
            <div class="alert alert-danger">@error.ErrorMessage</div>
        }
    }

    @if (ViewBag.Members != null)
    {
        <div class="dropdown mb-4">
            <button class="btn btn-outline-info dropdown-toggle d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-users"></i>
                Project Members
            </button>

            <ul class="dropdown-menu dropdown-menu-dark p-2 shadow" style="min-width: 250px;">
                @foreach (var member in ViewBag.Members)
                {
                    <li class="dropdown-item d-flex align-items-center justify-content-between gap-2 px-2 py-2 rounded-2">
                        <div class="d-flex align-items-center gap-2">
                            <div class="avatar bg-info text-white fw-semibold rounded-circle d-flex align-items-center justify-content-center"
                                 style="width: 28px; height: 28px; font-size: 0.8rem;">
                                @member.Member.PersonName?[0].ToString().ToUpper()
                            </div>
                            <div class="lh-sm">
                                <div class="fw-medium text-light" style="font-size: 0.85rem;">
                                    @member.Member.PersonName
                                </div>
                                <div class="text-info" style="font-size: 0.75rem;">
                                    @member.MemberRole
                                </div>
                            </div>
                        </div>

                        <form asp-controller="ProjectMembers"
                              asp-action="RemoveMember"
                              asp-route-projectId="@projectId"
                              asp-route-memberId="@member.Member.Id"
                              method="post" class="d-inline m-0">
                            <button type="submit" class="btn btn-outline-danger btn-sm" title="Remove Member">
                                <i class="fas fa-user-minus"></i>
                            </button>
                        </form>
                    </li>
                }
            </ul>
        </div>
    }

    <div class="d-flex flex-wrap gap-3 justify-content-start">
        @foreach (var s in Model)
        {
            <div class="card bg-dark text-white shadow-sm p-3 border border-secondary rounded-4" style="min-width: 300px; flex: 0 0 auto;">
                <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                    <h5 class="text-info m-0">@s.SectionName</h5>
                    <a asp-controller="Sections" asp-action="DeleteSection" asp-route-sectionId="@s.SectionId" asp-route-projectId="@s.ProjectId"
                       class="btn btn-sm btn-outline-danger" title="Delete Section">
                        <i class="fas fa-trash-alt"></i>
                    </a>
                </div>

                <div class="task-list" id="section-@s.SectionId" data-section-id="@s.SectionId" data-project-id="@s.ProjectId">
                @foreach (var task in s.Tasks)
                {
                    <div class="task-card mb-3 p-3 rounded-3 shadow-sm d-flex flex-column gap-2 position-relative" data-task-id="@task.TaskId">

                        <div class="d-flex justify-content-between align-items-start">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="taskCheck"
                                    data-status="@task.Status.ToString().ToLower()"
                                    data-task-id="@task.TaskId"
                                    @(task.Status == ProjectTaskStatus.COMPLETED ? "checked" : "") />
                            </div>

                            <div class="ms-2 flex-grow-1">
                                <strong style="color:@(task.Status == ProjectTaskStatus.COMPLETED ? "#979494d1" : "")" class="@(task.Status == ProjectTaskStatus.COMPLETED ? "text-decoration-line-through" : "") ">
                                    @task.Title
                                </strong>

                                @if (!string.IsNullOrWhiteSpace(task.Description))
                                {
                                    <div class="text-light small">@task.Description</div>
                                }

                                @if (task.ScheduleDateTime.HasValue)
                                {
                                    <div class="small text-warning">
                                        <i class="fas fa-clock me-1"></i>@task.ScheduleDateTime?.ToString("dd MMM yyyy hh:mm tt")
                                    </div>
                                }
                            </div>

                            <div class="btn-group btn-group-sm">
                                <a asp-controller="Tasks" asp-action="EditTask"
                                   asp-route-projectId="@task.ProjectId" asp-route-taskId="@task.TaskId"
                                   class="btn btn-outline-primary" title="Edit Task">
                                    <i class="fas fa-pen"></i>
                                </a>
                                <a asp-controller="Tasks" asp-action="DeleteTask"
                                   asp-route-projectId="@task.ProjectId" asp-route-taskId="@task.TaskId"
                                   class="btn btn-outline-danger" title="Delete Task">
                                    <i class="fas fa-trash-alt"></i>
                                </a>
                            </div>
                        </div>
                        <div class="dropdown mt-2">
                                <button id="selectedStatus" class="btn btn-sm d-flex align-items-center gap-2 px-2 py-1 rounded-2 border border-secondary text-light"
                                        type="button"
                                        data-bs-toggle="dropdown"
                                        aria-expanded="false"
                                        data-status="@task.Status.ToString().ToLower()"
                                        style="font-size: 0.8rem;">
                                    <span class="status-dot"
                                          style="width: 10px; height: 10px; border-radius: 50%;
                         background-color:@(task.Status == ProjectTaskStatus.PENDING ? "#ffc107" : task.Status == ProjectTaskStatus.IN_PROGRESS ? "#0d6efd" : task.Status == ProjectTaskStatus.COMPLETED ? "#198754" : "#6c757d");
                 display: inline-block;"></span>
                            <span>@task.Status.ToString().Replace("_", " ").ToUpperInvariant()</span>
                            <i class="fas fa-chevron-down ms-1 small"></i>
                        </button>

                                <ul class="dropdown-menu dropdown-menu-dark shadow-sm">
                                    @foreach (var status in Enum.GetValues(typeof(ProjectTaskStatus)).Cast<ProjectTaskStatus>())
                                    {
                                        <li>
                                            <button type="button"
                                                    class="dropdown-item d-flex align-items-center gap-2 status-option"
                                                    data-task-id="@task.TaskId"
                                                    data-status="@(status)">
                                                <span class="status-dot" style="width: 10px; height: 10px; border-radius: 50%; background-color:
                                    @(status == ProjectTaskStatus.PENDING ? "#ffc107" : status == ProjectTaskStatus.IN_PROGRESS ? "#0d6efd" : status == ProjectTaskStatus.COMPLETED ? "#198754" : "#6c757d");
                        display: inline-block;"></span>
                                    @status.ToString().Replace("_", " ").ToUpperInvariant()
                                </button>
                                        </li>
                                    }
                                </ul>
                            </div>

                    </div>
                }
                </div>

                <a asp-controller="Tasks" asp-action="Task"
                   asp-route-projectId="@projectId"
                   asp-route-sectionId="@s.SectionId"
                   class="btn btn-sm btn-outline-light w-100 mt-2">
                    <i class="fas fa-plus me-1"></i> Add Task
                </a>
            </div>
        }

        <div class="card bg-dark text-white border border-secondary p-3 rounded-4 d-flex align-items-center justify-content-start"
             style="min-width: 300px; flex: 0 0 auto;">
            <form asp-controller="Sections" asp-action="AddSection" method="post" class="w-100">
                <input type="hidden" name="ProjectId" value="@projectId" />
                <div class="mb-2">
                    <input name="SectionName" class="form-control bg-secondary text-white border-0" placeholder="New Section..." required />
                </div>
                <button type="submit" class="btn btn-outline-info w-100">
                    <i class="fas fa-plus me-1"></i> Add Section
                </button>
            </form>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
                document.querySelectorAll(".task-card").forEach(textCard => {
                    const checkbox = textCard.querySelector(".form-check-input");
                    const dropdownBtn = textCard.querySelector("#selectedStatus");
                    const spans = dropdownBtn.querySelectorAll("span");
                    const dotSpan = spans[0];
                    const textSpan = spans[1];
                    const text = textCard.querySelector("strong");
                    const taskId = checkbox.dataset.taskId;

                    checkbox.addEventListener("change", function() {
                    const newStatus = checkbox.checked ? "completed" : "pending";

                fetch(`/Tasks/taskState`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ 
                            taskId: taskId,
                            status: newStatus
                    })
                })
                .then(response => {
                    if (!response.ok) throw new Error("Failed to update task status");
                    return response.json();
                })
                .then(data => {
                    if (newStatus === "completed") {
                        text.classList.add("text-decoration-line-through");
                        text.style.color = "#979494d1";
                        dotSpan.style.backgroundColor = "#198754";
                            textSpan.textContent = "COMPLETED";
                    } else {
                        textCard.querySelector("strong").classList.remove("text-decoration-line-through");
                        text.style.color = "#ffffff";
                         dotSpan.style.backgroundColor = "#ffc107";
                            textSpan.textContent = "PENDING";
                    }
                            dropdownBtn.dataset.status = newStatus;
                })
                .catch(err => {
                    console.error("Error updating task state: ", err.message);
                    location.reload();
                });
            });

            document.querySelectorAll('.status-option').forEach(button => {
                    button.addEventListener('click', function () {
                        const taskId = this.dataset.taskId;
                        const newStatus = this.dataset.status;
                        const taskCard = this.closest('.task-card');
                        const checkbox = taskCard.querySelector(".form-check-input");
                        const text = taskCard.querySelector("strong");
                        const dropdownBtn = taskCard.querySelector("#selectedStatus");
                        const spans = dropdownBtn.querySelectorAll("span");
                        const dotSpan = spans[0];
                        const textSpan = spans[1];

                            fetch('/Tasks/taskState', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                            },
                            body: JSON.stringify({
                                taskId: taskId,
                                status: newStatus
                            })
                        })
                        .then(response => {
                            if (response.ok) {
                                if (newStatus === "COMPLETED") {
                                    text.classList.add("text-decoration-line-through");
                                    text.style.color = "#979494d1";
                                    dotSpan.style.backgroundColor = "#198754";
                                    textSpan.textContent = "COMPLETED";
                                    checkbox.checked = true;
                                } else if (newStatus == "PENDING") {
                                     dotSpan.style.backgroundColor = "#ffc107";
                                     textSpan.textContent = "PENDING";
                                     textCard.querySelector("strong").classList.remove("text-decoration-line-through");
                                     text.style.color = "#ffffff";
                                        checkbox.checked = false;
                                }
                                else {
                                     textSpan.textContent = "INPROGRESS";
                                     dotSpan.style.backgroundColor = "#0d6efd";
                                     textCard.querySelector("strong").classList.remove("text-decoration-line-through");
                                     dotSpan.style.backgroundColor = "#0d6efd";
                                     text.style.color = "#ffffff";
                                     checkbox.checked = false;
                                }
                            } else {
                                alert("Failed to update task status.");
                            }
                        });
                    });
                });
        });

                document.querySelectorAll(".task-list").forEach(list => {
        new Sortable(list, {
            group: "tasks",
            animation: 100,
            delay: 0,
            delayOnTouchStart: false,
            forceFallback: false, 
            fallbackTolerance: 0, 
            dragoverBubble: false,
            removeCloneOnHide: true,
            preventOnFilter: false,
            
            onStart: function(evt) {
                evt.item.style.opacity = "0.6";
                evt.item.style.transform = "rotate(5deg)";
            },
            
            onEnd: async function (evt) {
                evt.item.style.opacity = "1";
                evt.item.style.transform = "none";
                
                const taskId = evt.item.dataset.taskId;
                
                console.log("From element:", evt.from);
                console.log("To element:", evt.to);
                console.log("From attributes:", evt.from.attributes);
                console.log("To attributes:", evt.to.attributes);
                
                const oldSectionId = evt.from.dataset.sectionId;
                const newSectionId = evt.to.dataset.sectionId;
                const projectId = evt.to.dataset.projectId;

                console.log(`Task ID: ${taskId}`);
                console.log(`Old Section: ${oldSectionId}, New Section: ${newSectionId}`);
                console.log(`Project ID: ${projectId}`);

                if (oldSectionId === newSectionId) {
                    console.log("Task dropped in the same section. No API call.");
                    return;
                }

                try {
                    const response = await fetch("/Tasks/MoveTask", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            TaskId: taskId,
                            NewSectionId: newSectionId,
                            ProjectId: projectId
                        })
                    });

                    if (!response.ok) throw new Error("Failed to move task.");
                    console.log(`✅ Task ${taskId} moved from ${oldSectionId} to ${newSectionId}`);
                } catch (err) {
                    alert(err.message);
                    location.reload();
                }
            }
        });
    });
            });
    </script>
}