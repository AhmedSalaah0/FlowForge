@model IEnumerable<SectionWithTasksResponse>
@{
    ViewBag.Title = "Tasks";
    var projectId = ViewBag.ProjectId;
}

<div class="container mt-4">
    <div class="mb-4 border-bottom border-secondary pb-2">
        <h1 class="h3 text-light d-flex align-items-center gap-2">
            <i class="fas fa-columns"></i> Tasks Board
        </h1>
        <p class="text-muted">Manage your project tasks by sections</p>
    </div>

    <div class="d-flex overflow-auto gap-4 pb-3">
        @foreach (var s in Model)
        {
            <div class="card bg-dark text-white shadow-sm p-3 border border-secondary rounded-4" style="min-width: 300px; flex: 0 0 auto;">
                <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                    <h5 class="text-info m-0">@s.SectionName</h5>
                    <a asp-controller="Sections" asp-action="DeleteSection" asp-route-sectionId="@s.SectionId" asp-route-projectId="@s.ProjectId"
                       class="btn btn-sm btn-outline-danger" title="Delete Section">
                        <i class="fas fa-trash-alt"></i>
                    </a>
                </div>

                @foreach (var task in s.Tasks)
                {
                    <div class="task-card mb-3 p-3 rounded-3 shadow-sm d-flex flex-column gap-2 position-relative">

                        <div class="d-flex justify-content-between align-items-start">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox"
                                       onchange="CheckOrUnCheck('@task.TaskId', '@task.ProjectId')"
                                       @(task.Success ? "checked" : "") />
                            </div>

                            <div class="ms-2 flex-grow-1">
                                <strong class="@(task.Success ? "text-decoration-line-through text-muted" : "")">
                                    @task.Title
                                </strong>

                                @if (!string.IsNullOrWhiteSpace(task.Description))
                                {
                                    <div class="text-light small">@task.Description</div>
                                }

                                @if (task.ScheduleDateTime.HasValue)
                                {
                                    <div class="small text-warning">
                                        <i class="fas fa-clock me-1"></i>@task.ScheduleDateTime?.ToString("dd MMM yyyy hh:mm tt")
                                    </div>
                                }
                            </div>

                            <div class="btn-group btn-group-sm">
                                <a asp-controller="Tasks" asp-action="EditTask"
                                   asp-route-projectId="@task.ProjectId" asp-route-taskId="@task.TaskId"
                                   class="btn btn-outline-primary" title="Edit Task">
                                    <i class="fas fa-pen"></i>
                                </a>
                                <a asp-controller="Tasks" asp-action="DeleteTask"
                                   asp-route-projectId="@task.ProjectId" asp-route-taskId="@task.TaskId"
                                   class="btn btn-outline-danger" title="Delete Task">
                                    <i class="fas fa-trash-alt"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                }


                <a asp-controller="Tasks" asp-action="Task"
                   asp-route-projectId="@projectId"
                   asp-route-sectionId="@s.SectionId"
                   class="btn btn-sm btn-outline-light w-100 mt-2">
                    <i class="fas fa-plus me-1"></i> Add Task
                </a>
            </div>
        }

        <div class="card bg-dark text-white border border-secondary p-3 rounded-4 d-flex align-items-center justify-content-center"
             style="min-width: 300px; flex: 0 0 auto;">
            <form asp-controller="Sections" asp-action="AddSection" method="post" class="w-100">
                <input type="hidden" name="ProjectId" value="@projectId" />
                <div class="mb-2">
                    <input name="SectionName" class="form-control bg-secondary text-white border-0" placeholder="New Section..." required />
                </div>
                <button type="submit" class="btn btn-outline-info w-100">
                    <i class="fas fa-plus me-1"></i> Add Section
                </button>
            </form>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        function CheckOrUnCheck(taskId, projectId) {
            fetch(`/taskState/${taskId}`, {
                method: 'POST'
            })
            .then(response => {
                if (!response.ok) throw new Error("Failed to update task status");
                return response.json();
            })
            .then(data => console.log("Task updated:", data))
            .catch(err => alert(err.message));
        }
    </script>
}
